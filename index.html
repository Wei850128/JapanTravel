<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§é˜ªä¸ƒå¤©æ—…éŠå„€è¡¨æ¿</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* è‡ªå®šç¾©æ¨£å¼ */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700&display=swap');
        
        :root {
            --primary-color: #3b82f6; /* Blue 500 */
            --secondary-color: #10b981; /* Emerald 500 */
            --bg-color: #f1f5f9; /* Slate 100 - æ›´æŸ”å’Œçš„èƒŒæ™¯ */
        }
        body {
            font-family: 'Noto Sans TC', 'Inter', sans-serif;
            background-color: var(--bg-color);
        }
        .tab-button {
            transition: all 0.3s ease-in-out;
        }
        .card-shadow {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }
        /* æ¼¸å±¤æ¨™é¡Œ */
        .header-gradient {
            background-image: linear-gradient(to right, #0575E6, #021B79);
        }
        /* æ™‚é–“è»¸ä¸Šçš„åœ“é»å‹•ç•« */
        .timeline-dot {
            animation: pulse-dot 1.5s infinite;
        }
        @keyframes pulse-dot {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        /* å€’æ•¸è¨ˆæ™‚å™¨é¢¨æ ¼ */
        .countdown-segment {
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(5px);
        }
        /* æ–°å¢äº¤æ˜“æŒ‰éˆ•å‹•ç•« */
        .add-btn {
            transition: transform 0.1s ease-in-out;
        }
        .add-btn:active {
            transform: scale(0.98);
        }
    </style>
</head>
<body>

    <!-- ä¸»å®¹å™¨ -->
    <div class="max-w-4xl mx-auto min-h-screen bg-white shadow-2xl rounded-xl overflow-hidden">
        
        <!-- æ¨™é¡Œå€ - æ‡‰ç”¨æ¼¸å±¤èˆ‡åœ“è§’ -->
        <header class="header-gradient p-6 text-white shadow-xl">
            <h1 class="text-3xl font-extrabold tracking-wider border-b-2 border-white/30 pb-2">
                âœˆï¸ å¤§é˜ª ä¸ƒæ—¥æ—…ç¨‹
            </h1>
            <p class="text-sm opacity-80 mt-2">2026/02/26 ~ 03/04 (ä¸ƒå¤©å…­å¤œ) - éš¨æ™‚æŒæ¡è¡Œç¨‹å‹•æ…‹</p>
        </header>

        <!-- ä¸»å…§å®¹å€ -->
        <main class="p-4 sm:p-6">
            
            <!-- å°èˆª/Tab åˆ‡æ›å€ -->
            <div class="flex flex-wrap gap-1 sm:gap-2 mb-6 border-b border-gray-200">
                <button id="tab-overview" onclick="switchContent('overview')" class="tab-button px-4 py-2 text-sm font-bold text-blue-700 border-b-4 border-blue-500 hover:text-blue-600">è¡Œç¨‹ç¸½è¦½</button>
                <button id="tab-daily" onclick="switchContent('daily')" class="tab-button px-4 py-2 text-sm font-medium text-gray-500 border-b-4 border-transparent hover:border-gray-300 hover:text-gray-700">æ¯æ—¥è¡Œç¨‹</button>
                <button id="tab-booking" onclick="switchContent('booking')" class="tab-button px-4 py-2 text-sm font-medium text-gray-500 border-b-4 border-transparent hover:border-gray-300 hover:text-gray-700">è¨‚ä½/ç¥¨åˆ¸</button>
                <!-- æˆæœ¬æ§ç®¡é ç±¤æ›´æ–°ç‚ºæ›´æ˜ç¢ºçš„åç¨± -->
                <button id="tab-cost" onclick="switchContent('cost')" class="tab-button px-4 py-2 text-sm font-medium text-gray-500 border-b-4 border-transparent hover:border-gray-300 hover:text-gray-700">çµç®—ä¸­å¿ƒ</button>
            </div>

            <!-- å…§å®¹å€å¡Š (å‹•æ…‹åˆ‡æ›) -->
            <div id="content-overview" class="content-block"></div>
            <div id="content-daily" class="content-block hidden">
                <!-- æ¯æ—¥è¡Œç¨‹åˆ‡æ›æŒ‰éˆ• (Day 1, Day 2...) -->
                <div id="day-tabs" class="flex flex-wrap gap-2 mb-4 p-2 bg-gray-100 rounded-lg shadow-inner">
                    <!-- JS è¼‰å…¥æ—¥æœŸçš„æŒ‰éˆ• -->
                </div>
                <!-- æ¯æ—¥è¡Œç¨‹è©³ç´°å…§å®¹ -->
                <div id="daily-itinerary-detail"></div>
            </div>
            <div id="content-booking" class="content-block hidden"></div>
            <!-- çµç®—ä¸­å¿ƒå…§å®¹ -->
            <div id="content-cost" class="content-block hidden"></div>

        </main>
    </div>

    <script type="module">
        // Firebase æ¨¡çµ„è¼‰å…¥
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";


        // === 1. å…¨åŸŸè®Šæ•¸ & Firebase åˆå§‹åŒ– ===
        
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        
        // å¾å…¨åŸŸç’°å¢ƒç²å– Firebase é…ç½®
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // å•Ÿç”¨åµéŒ¯æ—¥èªŒ
        setLogLevel('debug');


        // é è¨­è¡Œç¨‹æ•¸æ“š (å·²è£œé½Šæ‰€æœ‰ä¸ƒå¤©çš„è³‡æ–™)
        let itineraryData = {
            overview: {
                startDate: "2026-02-26T11:15:00", 
                days: "7 å¤© 6 å¤œï¼ˆ2026/02/26 - 2026/03/04ï¼‰",
                pace: "ä¸­ç­‰åå¿«ã€‚å‰å››å¤©å¤§é˜ªå¸‚å€ï¼Œå¾Œä¸‰å¤©å‘¨é‚ŠåŸå¸‚ï¼ˆäº¬éƒ½/å¥ˆè‰¯ï¼‰å½ˆæ€§ä¸€æ—¥éŠã€‚",
                traffic: "åœ°éµ/JR ç‚ºä¸»ã€‚å»ºè­°è³¼è²· Kansai Area Pass æˆ– Kansai Thru Passï¼Œæ­é…å¤§é˜ªåœ°éµä¸€æ—¥åˆ¸ã€‚",
                budget: "ç´„ NT$ 40,000 - NT$ 55,000 (ä¸å«æ©Ÿç¥¨èˆ‡ä½å®¿)ã€‚",
                themes: [
                    "Day 1: å…¥å¢ƒèˆ‡åŸå¸‚æ¢ç´¢ï¼šé›£æ³¢/å¿ƒé½‹æ©‹/é“é “å €",
                    "Day 2: å½±åŸç‹‚æ­¡ï¼šæ—¥æœ¬ç’°çƒå½±åŸ (USJ)",
                    "Day 3: æ­·å²èˆ‡æµ·ç£ï¼šå¤§é˜ªåŸ & æµ·éŠé¤¨/å¤©ä¿å±±",
                    "Day 4: å¾©å¤èˆ‡æ½®æµï¼šæ–°ä¸–ç•Œ/é€šå¤©é–£ & æ¢…ç”°ç©ºä¸­åº­åœ’",
                    "Day 5: å¤éƒ½æ–‡åŒ–é«”é©—ï¼šä¼è¦‹ç¨»è·/æ¸…æ°´å¯º (äº¬éƒ½)",
                    "Day 6: æ²»ç™’èˆ‡é¹¿ï¼šå¥ˆè‰¯å…¬åœ’/æ±å¤§å¯º (å¥ˆè‰¯)",
                    "Day 7: æ¡è³¼èˆ‡è¿”ç¨‹ï¼šé»‘é–€å¸‚å ´/è‡¨ç©ºåŸ"
                ],
                costBreakdown: [
                    { category: "äº¤é€š", range: "$6,000 - $8,000", notes: "åŒ…å«æ©Ÿå ´äº¤é€šã€ä¸ƒæ—¥åœ°éµ/JR/ç§éµè²»ç”¨ã€‚" },
                    { category: "é¤é£²", range: "$12,000 - $18,000", notes: "å¹³å‡æ¯æ—¥ç´„ 8,000-12,000 JPYã€‚" },
                    { category: "é–€ç¥¨/æ´»å‹•", range: "$8,000 - $10,000", notes: "åŒ…å« USJã€å¤§é˜ªåŸã€æµ·éŠé¤¨ç­‰ä¸»è¦é–€ç¥¨ã€‚" },
                    { category: "å…¶ä»–/è³¼ç‰©", range: "$14,000 - $19,000", notes: "å½ˆæ€§é ç®—ï¼Œä¾å€‹äººæ¶ˆè²»ç¿’æ…£èª¿æ•´ã€‚" },
                ]
            },
            // ã€ä¿®å¾©é»ã€‘ï¼šè£œé½Š Day 2 åˆ° Day 6 çš„è¡Œç¨‹æ•¸æ“š
            daily: [
                {
                    dayNum: 1, date: "02/26", theme: "å…¥å¢ƒèˆ‡åŸå¸‚æ¢ç´¢",
                    stops: [
                        { time: "15:30", title: "é—œè¥¿æ©Ÿå ´ (KIX) - å¸‚å€", desc: "é£›æ©Ÿæ–¼ 14:55 æŠµé”ã€‚ä¹˜å—æµ·é›»éµ Rapi:t å‰å¾€é›£æ³¢ã€‚", cost: "1500 JPY", notes: "è³¼è²·äº¤é€šç¥¨åˆ¸ã€‚", mapLink: "https://www.google.com/maps/search/?api=1&query=é—œè¥¿åœ‹éš›æ©Ÿå ´" },
                        { time: "17:00", title: "è¾¦ç†é£¯åº—å…¥ä½", desc: "é›£æ³¢/å¿ƒé½‹æ©‹å€ï¼Œä¼‘æ¯æ•´é “ã€‚", cost: "-", notes: "ææ—©ç¢ºèªå…¥ä½æ™‚é–“ã€‚", mapLink: "" },
                        { time: "19:00", title: "é“é “å € (Dotonbori)", desc: "å›ºåŠ›æœè·‘è·‘äººï¼Œé«”é©—å¤§é˜ªç¾é£Ÿæ–‡åŒ–ã€‚", cost: "3500 JPY (æ™šé¤)", notes: "æ‹ç…§ç†±é»ã€‚", mapLink: "https://www.google.com/maps/search/?api=1&query=é“é “å €" },
                        { time: "21:00", title: "å¿ƒé½‹æ©‹ç­‹å•†åº—è¡—", desc: "è‡ªç”±è³¼ç‰©ã€è—¥å¦åº—æ¡è²·ã€‚", cost: "å½ˆæ€§", notes: "è¨±å¤šåº—å®¶æ™šä¸Š 9 é»é—œé–€ã€‚", mapLink: "" },
                    ],
                    flex: "è‹¥æŠµé”è¼ƒæ™šï¼Œå¯å°‡å¿ƒé½‹æ©‹è³¼ç‰©æ”¹è‡³ Day 7 å‚æ™šã€‚",
                },
                {
                    dayNum: 2, date: "02/27", theme: "å½±åŸç‹‚æ­¡ï¼šæ—¥æœ¬ç’°çƒå½±åŸ",
                    stops: [
                        { time: "08:30", title: "æ—¥æœ¬ç’°çƒå½±åŸ (USJ)", desc: "æ­ä¹˜ JR æ«»å³¶ç·šå‰å¾€ç’°çƒå½±åŸï¼Œè³¼è²·å¿«é€Ÿé€šé—œã€‚", cost: "8500 JPY (é–€ç¥¨)", notes: "ææ—©å…¥åœ’ï¼Œç›´å¥”ä»»å¤©å ‚ä¸–ç•Œï¼", mapLink: "https://www.google.com/maps/search/?api=1&query=æ—¥æœ¬ç’°çƒå½±åŸ" },
                        { time: "12:30", title: "åˆé¤æ™‚é–“", desc: "åœ¨åœ’å€å…§ä¸»é¡Œé¤å»³ç”¨é¤ã€‚", cost: "2500 JPY", notes: "å¯æå‰é è¨‚é¤å»³ã€‚", mapLink: "" },
                        { time: "19:00", title: "æ™šé¤èˆ‡è¿”å›", desc: "åœ¨ç’°çƒåŸå‘¨é‚Šç”¨é¤å¾Œï¼Œæ­ä¹˜ JR è¿”å›å¸‚å€ã€‚", cost: "3000 JPY", notes: "æ™šä¸Šæœ‰éŠè¡Œæ´»å‹•ã€‚", mapLink: "" },
                    ],
                    flex: "è‹¥äººæ½®éå¤šï¼Œå¯å°‡é‡é»æ”¾åœ¨ç‰¹å®šå€åŸŸä¸¦åˆ©ç”¨å–®äººé€šé“ã€‚",
                },
                {
                    dayNum: 3, date: "02/28", theme: "æ­·å²èˆ‡æµ·ç£ï¼šå¤§é˜ªåŸ & æµ·éŠé¤¨",
                    stops: [
                        { time: "09:00", title: "å¤§é˜ªåŸ (Osaka Castle)", desc: "æ­åœ°éµè‡³æ£®ä¹‹å®®ç«™ï¼Œåƒè§€å¤§é˜ªåœ°æ¨™ã€‚", cost: "600 JPY (å¤©å®ˆé–£)", notes: "è³æ«»å­£ç¯€å¯å®‰æ’æ›´å¤šæ™‚é–“ã€‚", mapLink: "https://www.google.com/maps/search/?api=1&query=å¤§é˜ªåŸ" },
                        { time: "12:30", title: "æµ·ç£å€åˆé¤", desc: "åœ¨å¤©ä¿å±±å¸‚å ´è¡—ç”¨é¤ã€‚", cost: "2000 JPY", notes: "å¤šç¨®é¸æ“‡ã€‚", mapLink: "" },
                        { time: "14:30", title: "æµ·éŠé¤¨ (Kaiyukan)", desc: "ä¸–ç•Œæœ€å¤§çš„æ°´æ—é¤¨ä¹‹ä¸€ï¼Œè§€è³é¯¨é¯Šã€‚", cost: "2700 JPY (é–€ç¥¨)", notes: "å»ºè­°é ç•™ 3 å°æ™‚ã€‚", mapLink: "https://www.google.com/maps/search/?api=1&query=æµ·éŠé¤¨" },
                        { time: "19:00", title: "æ™šé¤ - é›£æ³¢/å¿ƒé½‹æ©‹", desc: "å›å¸‚å€äº«ç”¨å¤§é˜ªç‡’ã€‚", cost: "3000 JPY", notes: "-", mapLink: "" },
                    ],
                    flex: "è‹¥ä¸åƒè§€å¤©å®ˆé–£ï¼Œå¯å°‡æ™‚é–“ç•™çµ¦æµ·éŠé¤¨é™„è¿‘çš„æ‘©å¤©è¼ªã€‚",
                },
                {
                    dayNum: 4, date: "03/01", theme: "å¾©å¤èˆ‡æ½®æµï¼šæ–°ä¸–ç•Œ & æ¢…ç”°",
                    stops: [
                        { time: "09:30", title: "æ–°ä¸–ç•Œ/é€šå¤©é–£ (Shinsekai/Tsutenkaku)", desc: "æ‡·èˆŠçš„è¡—å€ï¼Œå“åšä¸²ç‚¸ã€‚", cost: "900 JPY (é€šå¤©é–£)", notes: "æ—©æ™¨äººæ½®è¼ƒå°‘ã€‚", mapLink: "https://www.google.com/maps/search/?api=1&query=é€šå¤©é–£" },
                        { time: "12:00", title: "åˆé¤ - æ–°ä¸–ç•Œä¸²ç‚¸", desc: "æ’éšŠååº—ã€‚", cost: "2000 JPY", notes: "æ³¨æ„äºŒåº¦æ²¾é†¬ç¦æ­¢ã€‚", mapLink: "" },
                        { time: "15:00", title: "æ¢…ç”°å€è³¼ç‰©", desc: "JR å¤§é˜ªç«™å‘¨é‚Šç™¾è²¨å…¬å¸ã€‚", cost: "å½ˆæ€§", notes: "å¤§é˜ªæ½®æµä¸­å¿ƒã€‚", mapLink: "" },
                        { time: "18:00", title: "æ¢…ç”°ç©ºä¸­åº­åœ’ (Umeda Sky Building)", desc: "è§€è³æ—¥è½èˆ‡å¤œæ™¯ã€‚", cost: "1500 JPY (é–€ç¥¨)", notes: "æ’éšŠäººæ½®å¤šï¼Œå»ºè­°ææ—©ã€‚", mapLink: "https://www.google.com/maps/search/?api=1&query=æ¢…ç”°ç©ºä¸­åº­åœ’" },
                    ],
                    flex: "è‹¥å¤©æ°£ä¸ä½³ï¼Œå¯æ”¹åœ¨æ¢…ç”°åœ°ä¸‹è¡—é€²è¡Œæ·±åº¦è³¼ç‰©ã€‚",
                },
                {
                    dayNum: 5, date: "03/02", theme: "å¤éƒ½æ–‡åŒ–é«”é©—ï¼šäº¬éƒ½ä¸€æ—¥éŠ",
                    stops: [
                        { time: "08:00", title: "å‰å¾€äº¬éƒ½", desc: "æ­ä¹˜ JR æˆ–é˜ªæ€¥é›»éµå‰å¾€äº¬éƒ½ã€‚", cost: "1000 JPY (å–®ç¨‹)", notes: "è»Šç¨‹ç´„ 30-60 åˆ†é˜ã€‚", mapLink: "" },
                        { time: "10:00", title: "ä¼è¦‹ç¨»è·å¤§ç¤¾ (Fushimi Inari)", desc: "è‘—åçš„åƒæœ¬é³¥å±…ã€‚", cost: "å…è²»", notes: "çˆ¬åˆ°å±±é ‚ç´„éœ€ 2 å°æ™‚ã€‚", mapLink: "https://www.google.com/maps/search/?api=1&query=ä¼è¦‹ç¨»è·å¤§ç¤¾" },
                        { time: "13:00", title: "åˆé¤ - æ¸…æ°´å¯ºå‘¨é‚Š", desc: "åœ¨äºŒå¹´å‚ä¸‰å¹´å‚ä¸€å¸¶ç”¨é¤ã€‚", cost: "2500 JPY", notes: "è¨±å¤šç‰¹è‰²å°åƒã€‚", mapLink: "" },
                        { time: "15:00", title: "æ¸…æ°´å¯º (Kiyomizu-dera)", desc: "äº¬éƒ½åœ°æ¨™ï¼Œè§€è³æ¸…æ°´èˆå°ã€‚", cost: "400 JPY (é–€ç¥¨)", notes: "å¯ºé™¢ç¶­è­·ç‹€æ³éœ€ç•™æ„ã€‚", mapLink: "https://www.google.com/maps/search/?api=1&query=æ¸…æ°´å¯º" },
                    ],
                    flex: "è‹¥é«”åŠ›ä¸è¶³ï¼Œå¯æ”¾æ£„çˆ¬ä¼è¦‹ç¨»è·ï¼Œæ”¹åœ¨ç¥‡åœ’æˆ–æ²³åŸç”ºè³¼ç‰©ã€‚",
                },
                {
                    dayNum: 6, date: "03/03", theme: "æ²»ç™’èˆ‡é¹¿ï¼šå¥ˆè‰¯ä¸€æ—¥éŠ",
                    stops: [
                        { time: "09:00", title: "å‰å¾€å¥ˆè‰¯", desc: "æ­ä¹˜ JR æˆ–è¿‘éµå‰å¾€å¥ˆè‰¯ã€‚", cost: "600 JPY (å–®ç¨‹)", notes: "è¿‘éµå¥ˆè‰¯ç«™é›¢æ™¯é»è¼ƒè¿‘ã€‚", mapLink: "" },
                        { time: "10:30", title: "å¥ˆè‰¯å…¬åœ’ (Nara Park)", desc: "èˆ‡è‘—åçš„é‡ç”Ÿé¹¿ç¾¤äº’å‹•ã€‚", cost: "å…è²» (é¹¿ä»™è² 200 JPY)", notes: "é¹¿æœƒæ¶é£Ÿç‰©ï¼Œè«‹å°å¿ƒã€‚", mapLink: "https://www.google.com/maps/search/?api=1&query=å¥ˆè‰¯å…¬åœ’" },
                        { time: "12:30", title: "æ±å¤§å¯º (Todai-ji)", desc: "ä¸–ç•Œæœ€å¤§æœ¨é€ å»ºç¯‰ï¼Œè§€è³å¤§ä½›ã€‚", cost: "600 JPY (é–€ç¥¨)", notes: "éœ€è„«é‹é€²å…¥ã€‚", mapLink: "https://www.google.com/maps/search/?api=1&query=æ±å¤§å¯º" },
                        { time: "15:00", title: "æ˜¥æ—¥å¤§ç¤¾", desc: "ä¸–ç•Œéºç”¢ï¼Œåƒè§€è¬ç‡ˆç± ã€‚", cost: "å…è²» (æœ¬æ®¿ 500 JPY)", notes: "æ²¿é€”æ—é–“å°å¾‘èˆ’é©ã€‚", mapLink: "https://www.google.com/maps/search/?api=1&query=æ˜¥æ—¥å¤§ç¤¾" },
                    ],
                    flex: "è‹¥ä¸åƒè§€å¯ºå»Ÿï¼Œå¯å°‡æ™‚é–“ç•™çµ¦å‘¨é‚Šçš„å•†åº—è¡—å’Œç´€å¿µå“åº—ã€‚",
                },
                {
                    dayNum: 7, date: "03/04", theme: "æ¡è³¼èˆ‡è¿”ç¨‹",
                    stops: [
                        { time: "09:00", title: "é»‘é–€å¸‚å ´", desc: "ã€Œå¤§é˜ªçš„å»šæˆ¿ã€ï¼Œè³¼è²·æ–°é®®æµ·ç”¢ã€æ°´æœå’Œç´€å¿µå“ã€‚", cost: "å½ˆæ€§", notes: "ä¸Šåˆäººæ½®è¼ƒå¤šï¼Œè«‹æ—©é»å‰å¾€ã€‚", mapLink: "" },
                        { time: "11:00", title: "é€€æˆ¿èˆ‡åˆé¤", desc: "åˆé¤å¾Œå–è¡Œæã€‚", cost: "2500 JPY", notes: "-", mapLink: "" },
                        { time: "12:30", title: "è‡¨ç©ºåŸ Premium Outlets (å‚™é¸)", desc: "æœ€å¾Œè³¼ç‰©è¡åˆºï¼Œè«‹æŠŠæ¡æ™‚é–“ã€‚", cost: "å½ˆæ€§", notes: "ä½æ–¼é—œè¥¿æ©Ÿå ´å‰ä¸€ç«™ï¼Œè‹¥ç­æ©Ÿè¼ƒæ™šå¯è€ƒæ…®ã€‚", mapLink: "" },
                        { time: "13:30", title: "å‰å¾€é—œè¥¿æ©Ÿå ´ (KIX)", desc: "å‰å¾€é—œè¥¿æ©Ÿå ´ (KIX)ï¼Œæ­ä¹˜ 16:15 èˆªç­ã€‚", cost: "1500 JPY", notes: "è«‹å‹™å¿…åœ¨ 13:30 å‰å¾å¸‚å€å‡ºç™¼ã€‚", mapLink: "" },
                    ],
                    flex: "è‹¥æ™‚é–“è¼ƒç·Šï¼Œç›´æ¥åœ¨å¿ƒé½‹æ©‹å‘¨é‚Šå®Œæˆæœ€å¾Œè³¼ç‰©ï¼Œé¿å…å‰å¾€è‡¨ç©ºåŸã€‚",
                }
            ],
            booking: {
                prebooking: [
                    { item: "æ—¥æœ¬ç’°çƒå½±åŸ (USJ) é–€ç¥¨/å¿«é€Ÿé€šé—œåˆ¸", window: "è‡³å°‘ 1 å€‹æœˆå‰", note: "è¶…ç´šä»»å¤©å ‚ä¸–ç•Œå¼·çƒˆå»ºè­°è³¼è²·å¿«é€Ÿé€šé—œã€‚" },
                    { item: "ç±³å…¶æ—/é«˜äººæ°£é¤å»³", window: "è‡³å°‘ 2-3 é€±å‰", note: "é€éé£¯åº—æˆ–ç·šä¸Šé ç´„ç³»çµ±è¨‚ä½ã€‚" },
                    { item: "é˜¿å€é‡ Harukas 300 å±•æœ›å°", window: "æå‰ç·šä¸Šè³¼ç¥¨", note: "å¯çœå»ç¾å ´æ’éšŠæ™‚é–“ã€‚" },
                    { item: "äº¬éƒ½å’Œæœé«”é©—", window: "æå‰ 1 é€±é ç´„", note: "è‹¥ Day 5 æœ‰è¨ˆç•«ç©¿å’Œæœã€‚" },
                ],
                warnings: [
                    { type: "ä¼‘é¤¨æ—¥åœ°é›·", content: "è¨±å¤šåšç‰©é¤¨ã€ç¾è¡“é¤¨ï¼ˆå¦‚å¤§é˜ªæ­·å²åšç‰©é¤¨ï¼‰åœ¨é€±ä¸€ä¼‘é¤¨ï¼Œæ‡‰äº‹å…ˆæŸ¥è©¢ã€‚" },
                    { type: "å°–å³°æ™‚æ®µåœ°é›·", content: "é»‘é–€å¸‚å ´ä¸­åˆã€é“é “å €/å¿ƒé½‹æ©‹æ™šä¸Š 7-9 é»äººæ½®å¤šã€‚" },
                    { type: "äº¤é€šåœ°é›·", content: "å¤§é˜ªé€šå‹¤é«˜å³°æœŸï¼ˆæ—© 7:30-9:30, æ™š 5:30-7:30ï¼‰åœ°éµæ“æ“ ï¼Œç›¡é‡é¿é–‹ã€‚" },
                ]
            },
            cost: {
                // ã€æ–°å¢ã€‘æ”¯å‡ºèˆ‡çµç®—è³‡æ–™çµæ§‹
                people: ["å°æ˜", "é˜¿è¯", "å°è‰"], // é è¨­äººç‰©
                transactions: [
                    { id: crypto.randomUUID(), description: "äº¤é€šå¡å„²å€¼", amount: 10000, paidBy: "å°æ˜", sharedBy: ["å°æ˜", "é˜¿è¯", "å°è‰"], date: "2026-02-26" },
                    { id: crypto.randomUUID(), description: "Day 1 æ™šé¤ (é“é “å €)", amount: 8400, paidBy: "é˜¿è¯", sharedBy: ["å°æ˜", "é˜¿è¯", "å°è‰"], date: "2026-02-26" },
                    { id: crypto.randomUUID(), description: "USJ é–€ç¥¨", amount: 25500, paidBy: "å°è‰", sharedBy: ["å°æ˜", "é˜¿è¯", "å°è‰"], date: "2026-02-27" },
                ],
                summary: [], // çµç®—çµæœ
            }
        };

        let currentDay = 1;
        
        // --- Currency State ---
        let baseCurrency = 'JPY'; // äº¤æ˜“è¨˜éŒ„çš„åŸºç¤è²¨å¹£ (æ‰€æœ‰äº¤æ˜“é‡‘é¡çš†ä»¥æ­¤ç‚ºå–®ä½)
        let displayCurrency = 'JPY'; // ç›®å‰é¡¯ç¤ºçš„è²¨å¹£
        // å‡è¨­åŒ¯ç‡ï¼š1 JPY â‰ˆ 0.21 NTD (åƒ…ç‚ºç¯„ä¾‹ï¼Œå¯¦éš›è«‹ä¾éœ€æ±‚èª¿æ•´)
        const exchangeRateJPYtoNTD = 0.21; 
        const currencySymbols = {
            'JPY': 'Â¥',
            'NTD': 'NT$'
        };
        // ----------------------

        /**
         * æ ¼å¼åŒ–é‡‘é¡ï¼Œä¸¦å¯é€²è¡Œè²¨å¹£è½‰æ›
         * @param {number} amount - åŸºç¤è²¨å¹£ (JPY) çš„é‡‘é¡
         * @param {string} targetCurrency - ç›®æ¨™é¡¯ç¤ºè²¨å¹£ ('JPY' æˆ– 'NTD')
         * @returns {string} æ ¼å¼åŒ–å¾Œçš„é‡‘é¡å­—ç¬¦ä¸² (e.g., "Â¥10,000" or "NT$2,100")
         */
        function formatAmount(amount, targetCurrency) {
            if (typeof amount !== 'number') return `N/A`;

            let displayAmount = amount;
            let symbol = currencySymbols[baseCurrency];
            
            if (targetCurrency === 'NTD' && baseCurrency === 'JPY') {
                displayAmount = amount * exchangeRateJPYtoNTD;
                symbol = currencySymbols['NTD'];
            } else {
                // å¦‚æœç›®æ¨™æ˜¯ JPY æˆ–åŸºç¤è²¨å¹£ä¸æ˜¯ JPY (æœªä¾†æ“´å±•)ï¼Œå‰‡ä½¿ç”¨åŸºç¤è²¨å¹£ç¬¦è™Ÿ
                symbol = currencySymbols[targetCurrency] || targetCurrency;
            }

            // å››æ¨äº”å…¥åˆ°æ•´æ•¸ï¼Œä¸¦åŠ ä¸Šåƒåˆ†ä½
            return `${symbol}${Math.round(displayAmount).toLocaleString()}`;
        }


        // === 2. é›²ç«¯è³‡æ–™åº«æ“ä½œ (Firestore) ===

        /**
         * è¨­ç½®è³‡æ–™åº«è·¯å¾‘ (å…¬é–‹/å…±ç”¨è³‡æ–™)
         * ã€é—œéµè®Šæ›´ã€‘ï¼šå¾ç§äººè·¯å¾‘è®Šæ›´ç‚ºå…¬é–‹è·¯å¾‘ï¼Œå¯¦ç¾å¤šäººå…±ç”¨ã€‚
         * Path: /artifacts/{appId}/public/data/trip_itineraries/osaka_trip
         */
        function getItineraryDocRef() {
            if (!db) return null;
            // ç”±æ–¼æ˜¯å…±ç”¨æ–‡ä»¶ï¼Œæˆ‘å€‘ä½¿ç”¨ä¸€å€‹å›ºå®šåç¨±ä½œç‚ºæ–‡ä»¶IDï¼Œç¢ºä¿æ‰€æœ‰ç”¨æˆ¶è®€å–åŒä¸€å€‹æ–‡ä»¶ã€‚
            const docPath = `artifacts/${appId}/public/data/trip_itineraries/osaka_trip`;
            return doc(db, docPath);
        }

        /**
         * å„²å­˜ç•¶å‰è¡Œç¨‹è³‡æ–™åˆ° Firestore
         */
        async function saveItinerary() {
            const statusElement = document.getElementById('save-status');
            if (!statusElement) {
                console.error("Save status element not found. Skipping save status update.");
                return; 
            }

            const docRef = getItineraryDocRef();
            if (!docRef) {
                statusElement.textContent = 'âŒ å„²å­˜å¤±æ•—: è³‡æ–™åº«æœªå°±ç·’ã€‚';
                statusElement.classList.replace('text-yellow-600', 'text-red-600');
                return;
            }

            statusElement.textContent = 'ğŸ’¾ æ­£åœ¨å„²å­˜...';
            statusElement.classList.replace('text-red-600', 'text-yellow-600');
            statusElement.classList.replace('text-green-600', 'text-yellow-600');

            try {
                // ä½¿ç”¨ setDoc è¦†è“‹æ•´å€‹æ–‡ä»¶
                await setDoc(docRef, itineraryData);
                statusElement.textContent = 'âœ… è¡Œç¨‹å·²å„²å­˜è‡³é›²ç«¯ä¸¦å·²å…±ç”¨ï¼';
                statusElement.classList.replace('text-yellow-600', 'text-green-600');
                console.log("Itinerary successfully saved!");
            } catch (e) {
                statusElement.textContent = `âŒ å„²å­˜å¤±æ•—: ${e.message}`;
                statusElement.classList.replace('text-yellow-600', 'text-red-600');
                console.error("Error saving document: ", e);
            }
        }

        /**
         * ç›£è½ Firestore è³‡æ–™ä¸¦å³æ™‚æ›´æ–°è¡Œç¨‹æ•¸æ“š
         */
        function loadItinerary() {
            if (!db || !isAuthReady) return;

            const docRef = getItineraryDocRef();

            onSnapshot(docRef, (doc) => {
                let statusMessage = 'æ­£åœ¨è¼‰å…¥...';
                let statusClass = 'text-gray-500';

                if (doc.exists()) {
                    const savedData = doc.data();
                    if (savedData.overview && savedData.daily && savedData.cost) {
                        // ç¢ºä¿æ‰€æœ‰é—œéµéƒ¨åˆ†éƒ½å­˜åœ¨
                        itineraryData = savedData;
                        // ç¢ºä¿ expenses.summary å­˜åœ¨
                        if (!itineraryData.cost.summary) {
                             itineraryData.cost.summary = [];
                        }
                        statusMessage = 'âœ… é›²ç«¯è¡Œç¨‹å·²è¼‰å…¥ä¸¦å·²å…±ç”¨ã€‚';
                        statusClass = 'text-green-600';
                    } else {
                        statusMessage = 'âš ï¸ è¼‰å…¥è³‡æ–™ä¸å®Œæ•´ï¼Œå·²ä½¿ç”¨é è¨­è³‡æ–™ã€‚';
                        statusClass = 'text-red-600';
                    }
                } else {
                    statusMessage = 'â„¹ï¸ é€™æ˜¯æ–°çš„è¡Œç¨‹ï¼Œè«‹é»æ“Šå„²å­˜ä»¥å»ºç«‹å…±ç”¨æ–‡ä»¶ã€‚';
                    statusClass = 'text-yellow-600';
                }
                
                // ã€æ ¸å¿ƒä¿®å¾©é»ã€‘ï¼šå…ˆæ¸²æŸ“ç•«é¢ï¼Œç¢ºä¿æ‰€æœ‰å…ƒç´ åœ¨ DOM ä¸­
                renderAllContent();

                // 2. æ›´æ–°ç‹€æ…‹è¨Šæ¯ 
                const statusElement = document.getElementById('save-status');
                if (statusElement) {
                    statusElement.textContent = statusMessage;
                    statusElement.className = `text-xs mt-2 ${statusClass}`;
                }
            }, (error) => {
                console.error("Error listening to document:", error);
                const statusElement = document.getElementById('save-status');
                if (statusElement) {
                    statusElement.textContent = `âŒ é€£ç·šå¤±æ•—: ${error.message}`;
                    statusElement.classList.remove('text-green-600', 'text-yellow-600');
                    statusElement.classList.add('text-red-600');
                }
            });
        }

        // === 3. ç•«é¢æ¸²æŸ“èˆ‡äº‹ä»¶è™•ç† ===

        let countdownInterval;

        function renderAllContent() {
            renderOverview();
            renderDayTabs();
            renderBooking();
            renderCost(); 
            switchDay(currentDay);
        }

        // è¨ˆç®—å€’æ•¸è¨ˆæ™‚ä¸¦æ›´æ–°ç•«é¢
        function updateCountdown() {
            const tripStartTime = new Date(itineraryData.overview.startDate).getTime();
            const now = new Date().getTime();
            const distance = tripStartTime - now;

            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);

            const countdownElement = document.getElementById('countdown-timer');

            if (!countdownElement) { return; }

            if (distance < 0) {
                countdownElement.innerHTML = '<span class="text-lg font-bold text-green-600">æ—…ç¨‹é€²è¡Œä¸­ï¼ç›¡æƒ…äº«å—ï¼</span>';
                if (countdownInterval) {
                     clearInterval(countdownInterval);
                     countdownInterval = null;
                }
            } else {
                countdownElement.innerHTML = `
                    <p class="text-sm font-medium text-gray-600 mb-2">è·é›¢å‡ºç™¼ (${itineraryData.daily[0].date} 11:15) å€’æ•¸ï¼š</p>
                    <div class="flex justify-center space-x-3 sm:space-x-5 text-gray-800">
                        <div class="countdown-segment p-2 rounded-lg card-shadow">
                            <div class="text-2xl sm:text-3xl font-extrabold text-blue-600">${String(days).padStart(2, '0')}</div>
                            <div class="text-xs sm:text-sm font-medium">å¤©</div>
                        </div>
                        <div class="countdown-segment p-2 rounded-lg card-shadow">
                            <div class="text-2xl sm:text-3xl font-extrabold text-blue-600">${String(hours).padStart(2, '0')}</div>
                            <div class="text-xs sm:text-sm font-medium">å°æ™‚</div>
                        </div>
                        <div class="countdown-segment p-2 rounded-lg card-shadow hidden sm:block">
                            <div class="text-2xl sm:text-3xl font-extrabold text-blue-600">${String(minutes).padStart(2, '0')}</div>
                            <div class="text-xs sm:text-sm font-medium">åˆ†é˜</div>
                        </div>
                        <div class="countdown-segment p-2 rounded-lg card-shadow hidden sm:block">
                            <div class="text-2xl sm:text-3xl font-extrabold text-blue-600">${String(seconds).padStart(2, '0')}</div>
                            <div class="text-xs sm:text-sm font-medium">ç§’</div>
                        </div>
                    </div>
                `;
            }
        }

        // æ¸²æŸ“è¡Œç¨‹ç¸½è¦½ (Overview)
        function renderOverview() {
            const overview = itineraryData.overview;
            const content = `
                <div class="text-center mb-8 p-4 bg-white/70 rounded-xl card-shadow border border-blue-200">
                    <div id="countdown-timer" class="p-3">
                        <span class="text-gray-500">è¼‰å…¥å€’æ•¸ä¸­...</span>
                    </div>

                    <!-- é›²ç«¯å„²å­˜å€å¡Š -->
                    <div class="mt-4 pt-3 border-t border-gray-200">
                        <button onclick="saveItinerary()" 
                                class="px-5 py-2 bg-blue-600 text-white font-bold rounded-full hover:bg-blue-700 transition duration-200 shadow-lg flex items-center justify-center mx-auto">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v8a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>
                            å„²å­˜è¡Œç¨‹åˆ°é›²ç«¯ (å…±ç”¨)
                        </button>
                        <p id="save-status" class="text-xs mt-2 text-gray-500">æ­£åœ¨ç­‰å¾…é›²ç«¯é€£ç·š...</p>
                        <p class="text-xs text-blue-500 mt-1">æ­¤è³‡æ–™å°‡**å…±ç”¨**çµ¦æ‰€æœ‰ä½¿ç”¨æ­¤ App çš„æˆå“¡ã€‚</p>
                    </div>
                </div>

                <h2 class="text-2xl font-bold text-gray-800 mb-5 border-l-4 border-blue-500 pl-3">è¡Œç¨‹ç¸½è¦½ (å†’é ­æ‘˜è¦)</h2>
                <div class="grid md:grid-cols-2 gap-4">
                    <div class="p-5 bg-blue-50 rounded-xl card-shadow border border-blue-200">
                        <h3 class="font-bold text-lg text-blue-700 mb-2">ğŸ“† æ—…ç¨‹æ¦‚è¦</h3>
                        <p class="mt-1 text-sm"><strong class="text-gray-600">å¤©æ•¸ï¼š</strong> ${overview.days}</p>
                        <p class="text-sm"><strong class="text-gray-600">ç¯€å¥ï¼š</strong> ${overview.pace}</p>
                        <p class="text-sm"><strong class="text-gray-600">äº¤é€šï¼š</strong> ${overview.traffic}</p>
                    </div>

                    <div class="p-5 bg-yellow-50 rounded-xl card-shadow border border-yellow-200">
                        <h3 class="font-bold text-lg text-yellow-700 mb-2">ğŸ’° ç¸½é ç®—æ¦‚ç®—</h3>
                        <p class="mt-1 text-xl font-bold text-red-600">${overview.budget}</p>
                        <p class="text-xs text-gray-500 mt-1">ï¼ˆä¸å«æ©Ÿç¥¨èˆ‡ä½å®¿è²»ç”¨ï¼‰</p>
                    </div>
                </div>

                <div class="mt-6 p-5 bg-green-50 rounded-xl card-shadow border border-green-200">
                    <h3 class="font-bold text-lg text-green-700 mb-3">ğŸ—ºï¸ æ¯æ—¥ä¸»é¡Œèˆ‡è²»ç”¨åˆ†ä½ˆ</h3>
                    <div class="grid md:grid-cols-2 gap-4">
                        <!-- æ¯æ—¥ä¸»é¡Œ -->
                        <div>
                            <h4 class="text-sm font-medium text-gray-700 mb-1">æ¯æ—¥ä¸»é¡Œ</h4>
                            <ul class="text-sm list-decimal pl-5 mt-1 space-y-1">
                                ${overview.themes.map(theme => `<li>${theme}</li>`).join('')}
                            </ul>
                        </div>
                        <!-- è²»ç”¨åˆ†ä½ˆ -->
                        <div>
                            <h4 class="text-sm font-medium text-gray-700 mb-1">è²»ç”¨åˆ†ä½ˆ (å–®äºº NTD)</h4>
                            <ul class="text-xs list-disc pl-5 mt-1 space-y-1">
                                ${overview.costBreakdown.map(item => `
                                    <li><strong class="text-gray-700">${item.category} (${item.range})ï¼š</strong> ${item.notes}</li>
                                `).join('')}
                            </ul>
                        </div>
                    </div>
                </div>
                <!-- é¡¯ç¤º userId ä¾›é™¤éŒ¯å’Œè­˜åˆ¥ -->
                <p class="mt-4 text-xs text-gray-400 text-right">User ID: ${userId || 'N/A'}</p>
            `;
            document.getElementById('content-overview').innerHTML = content;
        }

        // æ¸²æŸ“æ¯æ—¥è¡Œç¨‹çš„ Tab æŒ‰éˆ• (ä¾æ“š itineraryData.daily æ¸²æŸ“)
        function renderDayTabs() {
            const dayTabsContainer = document.getElementById('day-tabs');
            dayTabsContainer.innerHTML = itineraryData.daily.map(day => `
                <button id="day-tab-${day.dayNum}" onclick="switchDay(${day.dayNum})" 
                        class="day-tab-button px-4 py-1 text-sm font-medium rounded-full 
                        bg-gray-200 text-gray-700 hover:bg-blue-300 hover:text-white transition duration-200 shadow-md">
                    Day ${day.dayNum} (${day.date.slice(2)})
                </button>
            `).join('');
        }

        // æ¸²æŸ“è¨‚ä½/ç¥¨åˆ¸/æ³¨æ„äº‹é … (Booking)
        function renderBooking() {
            const booking = itineraryData.booking;
            const content = `
                <h2 class="text-2xl font-bold text-gray-800 mb-5 border-l-4 border-blue-500 pl-3">ğŸ« è¨‚ä½/ç¥¨åˆ¸/æ³¨æ„äº‹é …</h2>
                
                <section class="mb-8">
                    <h3 class="text-xl font-semibold text-blue-700 mb-4 border-b pb-2">éœ€æå‰é ç´„çš„é …ç›®</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white rounded-xl card-shadow">
                            <thead>
                                <tr class="text-left text-xs text-white uppercase bg-blue-600">
                                    <th class="p-3 rounded-tl-xl">é …ç›®</th>
                                    <th class="p-3">å»ºè­°é ç´„æ™‚é–“çª—å£</th>
                                    <th class="p-3 rounded-tr-xl">å‚™è¨»</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${booking.prebooking.map(item => `
                                    <tr class="border-b last:border-b-0 hover:bg-gray-50 text-sm">
                                        <td class="p-3 font-medium">${item.item}</td>
                                        <td class="p-3 text-red-500 font-bold">${item.window}</td>
                                        <td class="p-3 text-gray-600">${item.note}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </section>

                <section>
                    <h3 class="text-xl font-semibold text-blue-700 mb-4 border-b pb-2">ğŸš¨ å¸¸è¦‹åœ°é›·æˆ–æ›¿ä»£æ–¹æ¡ˆ</h3>
                    <ul class="space-y-4">
                        ${booking.warnings.map(warn => `
                            <li class="p-4 border-2 border-dashed border-red-400 bg-red-50 rounded-xl text-sm card-shadow">
                                <strong class="text-red-700 text-base block mb-1">${warn.type}ï¼š</strong> 
                                ${warn.content}
                            </li>
                        `).join('')}
                    </ul>
                </section>
            `;
            document.getElementById('content-booking').innerHTML = content;
        }

        // ã€æ–°å¢ã€‘è¨­å®šé¡¯ç¤ºè²¨å¹£ä¸¦é‡æ–°æ¸²æŸ“ Cost é é¢
        function setDisplayCurrency(currency) {
            if (currency === displayCurrency) return;
            displayCurrency = currency;
            renderCost();
        }

        // è²»ç”¨è¿½è¹¤èˆ‡çµç®—ä¸­å¿ƒ (Cost)
        function renderCost() {
            const cost = itineraryData.cost;
            const people = cost.people || [];
            const transactions = cost.transactions || [];
            const summary = cost.summary || [];
            const today = new Date().toISOString().substring(0, 10);
            const symbol = currencySymbols[baseCurrency]; // åŸºç¤è²¨å¹£ç¬¦è™Ÿï¼Œç”¨æ–¼è¼¸å…¥æ¡†

            // 1. æ¸²æŸ“äººå“¡åˆ—è¡¨
            const peopleListHtml = people.length > 0
                ? people.map((name, index) => `
                    <div class="flex items-center justify-between p-2 bg-white rounded-lg shadow-sm border border-gray-200">
                        <span class="text-base font-semibold text-gray-800">${name}</span>
                        <button onclick="removePerson('${name}')" class="text-red-500 hover:text-red-700 transition">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3m-4 0h14"></path></svg>
                        </button>
                    </div>
                `).join('')
                : '<p class="text-sm text-gray-500 p-2 text-center">è«‹æ–°å¢æˆå“¡é–‹å§‹è¿½è¹¤æ”¯å‡ºã€‚</p>';

            // 2. æ¸²æŸ“äº¤æ˜“åˆ—è¡¨
            const transactionsHtml = transactions.length > 0
                ? transactions.map(t => {
                    const displayAmount = formatAmount(t.amount, displayCurrency);
                    return `
                        <div class="p-4 bg-white rounded-xl border border-gray-100 shadow-md">
                            <div class="flex justify-between items-start">
                                <h4 class="text-lg font-bold text-blue-700">${t.description}</h4>
                                <span class="text-xl font-extrabold text-red-600">${displayAmount}</span>
                            </div>
                            <p class="text-sm text-gray-600 mt-1">
                                <strong class="text-green-700">${t.paidBy}</strong> æ”¯ä»˜ã€‚
                                <span class="text-gray-500 ml-2">${t.date}</span>
                            </p>
                            <p class="text-xs text-gray-500 mt-2">å…±ç”¨äººï¼š${t.sharedBy.join(', ')}</p>
                            <button onclick="removeTransaction('${t.id}')" class="text-xs text-red-400 hover:text-red-600 mt-2">åˆªé™¤</button>
                        </div>
                    `;
                }).join('')
                : '<p class="text-sm text-gray-500 p-4 text-center">å°šç„¡æ”¯å‡ºç´€éŒ„ã€‚æ–°å¢ç¬¬ä¸€ç­†äº¤æ˜“ï¼</p>';

            // 3. æ¸²æŸ“çµç®—çµæœ
            // åªé¡¯ç¤ºé‡‘é¡å¤§æ–¼ 0.01 çš„çµç®—é …ç›®
            const summaryHtml = summary.filter(s => s.amount > 0.01)
                .map(s => {
                    // amount å·²ç¶“æ˜¯æ­£æ•¸ (payment)
                    const displayAmount = formatAmount(s.amount, displayCurrency); 
                    return `<li class="flex justify-between items-center p-3 bg-green-100 rounded-lg border-l-4 border-green-500">
                        <span class="text-sm text-gray-700">${s.from} æ‡‰è©²ä»˜çµ¦ ${s.to}</span>
                        <span class="text-lg font-bold text-green-700">${displayAmount}</span>
                    </li>`;
                }).join('');

            const content = `
                <h2 class="text-2xl font-bold text-gray-800 mb-5 border-l-4 border-purple-500 pl-3">ğŸ“Š å…±ç”¨æ”¯å‡ºèˆ‡çµç®—ä¸­å¿ƒ</h2>
                
                <!-- ã€æ–°å¢ã€‘è²¨å¹£åˆ‡æ›å€å¡Š -->
                <div class="flex justify-end items-center mb-4">
                    <span class="text-sm text-gray-600 mr-2">é¡¯ç¤ºè²¨å¹£ï¼š</span>
                    <select onchange="setDisplayCurrency(this.value)" class="p-2 border rounded-lg bg-white text-sm font-semibold shadow-sm focus:ring-purple-500 focus:border-purple-500">
                        <option value="JPY" ${displayCurrency === 'JPY' ? 'selected' : ''}>æ—¥åœ“ (Â¥)</option>
                        <option value="NTD" ${displayCurrency === 'NTD' ? 'selected' : ''}>å°å¹£ (NT$)</option>
                    </select>
                </div>

                <div class="grid md:grid-cols-3 gap-6 mb-8">
                    <!-- 1. æˆå“¡ç®¡ç† -->
                    <div class="md:col-span-1 p-5 bg-white rounded-xl card-shadow border border-gray-200">
                        <h3 class="text-xl font-bold text-purple-700 mb-4">ğŸ‘¥ æˆå“¡åˆ—è¡¨</h3>
                        <div id="people-list" class="space-y-2 mb-4 h-48 overflow-y-auto pr-1">
                            ${peopleListHtml}
                        </div>
                        <div class="flex space-x-2">
                            <input type="text" id="new-person-name" placeholder="è¼¸å…¥æˆå“¡åç¨±" class="w-full p-2 border border-gray-300 rounded-lg text-sm focus:ring-purple-500 focus:border-purple-500">
                            <button onclick="addPerson()" class="add-btn bg-purple-600 text-white p-2 rounded-lg hover:bg-purple-700 transition duration-150">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                            </button>
                        </div>
                    </div>

                    <!-- 2. æ–°å¢äº¤æ˜“ -->
                    <div class="md:col-span-2 p-5 bg-purple-50 rounded-xl card-shadow border border-purple-200">
                        <h3 class="text-xl font-bold text-purple-700 mb-4">ğŸ’¸ æ–°å¢äº¤æ˜“ç´€éŒ„ (åŸºç¤è²¨å¹£: ${baseCurrency})</h3>
                        <form id="add-transaction-form" onsubmit="event.preventDefault(); addTransaction();">
                            <div class="grid sm:grid-cols-2 gap-4">
                                <input type="text" id="transaction-desc" placeholder="è²»ç”¨æè¿° (e.g., USJ é–€ç¥¨)" required class="col-span-2 p-2 border rounded-lg">
                                
                                <!-- é‡‘é¡è¼¸å…¥æ¡† - æ¨™ç¤ºåŸºç¤è²¨å¹£ -->
                                <div class="relative">
                                    <input type="number" id="transaction-amount" placeholder="é‡‘é¡ (æ—¥åœ“ Â¥)" required min="1" class="w-full p-2 pl-10 border rounded-lg">
                                    <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 font-semibold">${currencySymbols[baseCurrency]}</span>
                                </div>

                                <input type="date" id="transaction-date" value="${today}" required class="p-2 border rounded-lg">

                                <select id="paid-by" class="p-2 border rounded-lg bg-white" required>
                                    <option value="" disabled selected>èª°æ”¯ä»˜äº†é€™ç­†è²»ç”¨ï¼Ÿ</option>
                                    ${people.map(name => `<option value="${name}">${name}</option>`).join('')}
                                </select>
                                
                                <div class="col-span-2 p-2 border rounded-lg bg-white">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">å…±åŒåˆ†æ”¤äºº (å‹¾é¸)ï¼š</label>
                                    <div id="shared-by-checkboxes" class="flex flex-wrap gap-x-4 gap-y-2">
                                        ${people.map(name => `
                                            <label class="flex items-center space-x-1 text-sm">
                                                <input type="checkbox" name="shared-person" value="${name}" checked class="rounded text-purple-600 focus:ring-purple-500">
                                                <span>${name}</span>
                                            </label>
                                        `).join('')}
                                        ${people.length === 0 ? '<span class="text-red-500">è«‹å…ˆæ–°å¢æˆå“¡ï¼</span>' : ''}
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="add-btn mt-4 w-full py-2 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition shadow-lg">
                                <svg class="w-5 h-5 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                è¨˜éŒ„æ”¯å‡º
                            </button>
                        </form>
                    </div>
                </div>

                <!-- 3. äº¤æ˜“åˆ—è¡¨èˆ‡çµç®—çµæœ -->
                <h3 class="text-xl font-bold text-gray-800 mb-4 border-l-4 border-blue-500 pl-3">ğŸ“ äº¤æ˜“æ­·å²ç´€éŒ„ (${transactions.length} ç­†)</h3>
                <div class="grid md:grid-cols-2 gap-4 mb-8 max-h-96 overflow-y-auto pr-1">
                    ${transactionsHtml}
                </div>

                <div class="p-5 bg-blue-50 rounded-xl card-shadow border border-blue-200">
                    <div class="flex justify-between items-center mb-4 border-b pb-3">
                        <h3 class="text-xl font-bold text-blue-700">âš–ï¸ çµç®—çµæœ (èª°è©²ä»˜èª°å¤šå°‘)</h3>
                        <button onclick="calculateSettlement(true)" class="add-btn px-4 py-2 bg-blue-600 text-white font-bold rounded-full hover:bg-blue-700 transition shadow-md">
                            ç«‹å³çµç®—
                        </button>
                    </div>
                    <ul class="space-y-3" id="settlement-summary">
                        ${summaryHtml}
                    </ul>
                </div>
            `;
            document.getElementById('content-cost').innerHTML = content;
        }

        // === 4. è²»ç”¨è¿½è¹¤æ ¸å¿ƒé‚è¼¯ ===

        /**
         * æ–°å¢æˆå“¡
         */
        function addPerson() {
            const input = document.getElementById('new-person-name');
            const name = input.value.trim();

            if (name && !itineraryData.cost.people.includes(name)) {
                itineraryData.cost.people.push(name);
                input.value = '';
                // æ¸…ç©ºçµç®—çµæœï¼Œå› ç‚ºäººå“¡è®Šå‹•äº†
                itineraryData.cost.summary = []; 
                saveItinerary(); // å„²å­˜ä¸¦è§¸ç™¼ onSnapshot é‡æ–°æ¸²æŸ“
            }
        }

        /**
         * åˆªé™¤æˆå“¡
         */
        function removePerson(name) {
            itineraryData.cost.people = itineraryData.cost.people.filter(p => p !== name);
            // åŒæ­¥åˆªé™¤æ‰€æœ‰äº¤æ˜“ä¸­ç›¸é—œçš„å…±ç”¨äºº
            itineraryData.cost.transactions.forEach(t => {
                t.sharedBy = t.sharedBy.filter(p => p !== name);
            });
            // é‡æ–°è¨ˆç®—çµç®— (ä¸å¼·åˆ¶å„²å­˜ï¼Œè®“ onSnapshot è™•ç†)
            calculateSettlement(false);
            saveItinerary(); // å„²å­˜äººå“¡è®Šå‹•
        }

        /**
         * æ–°å¢äº¤æ˜“
         */
        function addTransaction() {
            const desc = document.getElementById('transaction-desc').value.trim();
            // é‡‘é¡è¼¸å…¥æ˜¯ JPY
            const amount = parseInt(document.getElementById('transaction-amount').value, 10);
            const date = document.getElementById('transaction-date').value;
            const paidBy = document.getElementById('paid-by').value;
            const sharedByCheckboxes = document.querySelectorAll('input[name="shared-person"]:checked');
            
            const sharedBy = Array.from(sharedByCheckboxes).map(cb => cb.value);
            // æ¸…é™¤èˆŠçš„éŒ¯èª¤è¨Šæ¯ (å¦‚æœæœ‰)
            document.querySelectorAll('.transaction-error').forEach(el => el.remove()); 

            if (!desc || isNaN(amount) || amount <= 0 || !paidBy || sharedBy.length === 0) {
                 // ä½¿ç”¨è‡ªå®šç¾©éŒ¯èª¤æç¤ºï¼Œå–ä»£ alert()
                document.getElementById('add-transaction-form').insertAdjacentHTML('afterend', '<p class="text-red-500 mt-2 transaction-error">è«‹ç¢ºèªæ‰€æœ‰æ¬„ä½éƒ½å·²å¡«å¯«ä¸¦å‹¾é¸å…±ç”¨äººã€‚</p>');
                return;
            }

            const newTransaction = {
                id: crypto.randomUUID(), // ä½¿ç”¨ UUID ç¢ºä¿å”¯ä¸€æ€§
                description: desc,
                amount: amount, // åŸºç¤è²¨å¹£ (JPY)
                paidBy: paidBy,
                sharedBy: sharedBy,
                date: date
            };

            itineraryData.cost.transactions.push(newTransaction);
            document.getElementById('add-transaction-form').reset(); // é‡è¨­è¡¨å–®
            // é‡è¨­å…±ç”¨äººé¸é …ç‚ºå…¨é¸ç‹€æ…‹
            document.querySelectorAll('input[name="shared-person"]').forEach(cb => cb.checked = true);

            // æ¸…ç©ºçµç®—çµæœï¼Œä¸‹æ¬¡æ‰‹å‹•é»æ“Šè¨ˆç®—
            itineraryData.cost.summary = [];
            saveItinerary(); // å„²å­˜ä¸¦è§¸ç™¼ onSnapshot é‡æ–°æ¸²æŸ“
        }

        /**
         * åˆªé™¤äº¤æ˜“
         */
        function removeTransaction(id) {
            itineraryData.cost.transactions = itineraryData.cost.transactions.filter(t => t.id !== id);
            // é‡æ–°è¨ˆç®—çµç®—
            calculateSettlement(false);
            saveItinerary(); // å„²å­˜äº¤æ˜“è®Šå‹•
        }


        /**
         * è¨ˆç®—æœ€çµ‚çš„çµç®—æ¸…å–®
         * @param {boolean} shouldSave æ˜¯å¦åœ¨è¨ˆç®—å®Œæˆå¾Œç«‹å³å„²å­˜ä¸¦é‡æ–°æ¸²æŸ“ (åƒ…åœ¨ç”¨æˆ¶é»æ“ŠæŒ‰éˆ•æ™‚ç‚º true)
         */
        function calculateSettlement(shouldSave) {
            const people = itineraryData.cost.people;
            const transactions = itineraryData.cost.transactions;

            if (people.length === 0) {
                itineraryData.cost.summary = [];
                if (shouldSave) saveItinerary();
                return;
            }

            // 1. è¨ˆç®—æ¯å€‹äººçš„æ·¨é¤˜é¡ (Paid - Owed)
            const balances = {};
            people.forEach(p => balances[p] = 0);

            transactions.forEach(t => {
                const shareCount = t.sharedBy.length;
                if (shareCount === 0) return;

                const perPersonShare = t.amount / shareCount;

                // å¢åŠ å·²ä»˜æ¬¾é‡‘é¡ (PaidBy)
                balances[t.paidBy] += t.amount;

                // æ‰£é™¤æ‡‰ä»˜é‡‘é¡ (SharedBy)
                t.sharedBy.forEach(p => {
                    // åªæœ‰ç•¶å…±ç”¨äººå­˜åœ¨æ–¼ç•¶å‰äººå“¡åˆ—è¡¨æ™‚æ‰é€²è¡Œè¨ˆç®—
                    if (balances[p] !== undefined) {
                        balances[p] -= perPersonShare;
                    }
                });
            });

            // 2. æº–å‚™çµç®—æ¸…å–® (Settlement List)
            
            // å°‡é¤˜é¡åˆ†æˆå…©çµ„ï¼šæ¬ æ¬¾äºº (Owed, é¤˜é¡ < 0) å’Œå‚µæ¬Šäºº (Lender, é¤˜é¡ > 0)
            let lenders = []; 
            let debtors = []; 

            for (const person in balances) {
                if (balances[person] > 0.01) { // é¿å…æ¥µå°çš„æµ®é»æ•¸èª¤å·®
                    lenders.push({ name: person, amount: balances[person] });
                } else if (balances[person] < -0.01) {
                    debtors.push({ name: person, amount: balances[person] });
                }
            }

            let settlements = [];
            let i = 0; // å‚µæ¬Šäººç´¢å¼•
            let j = 0; // æ¬ æ¬¾äººç´¢å¼•

            // è²ªå©ªç®—æ³•é€²è¡Œçµç®—
            while (i < lenders.length && j < debtors.length) {
                const lender = lenders[i];
                const debtor = debtors[j];
                
                // æ¬ æ¬¾äººé‚„éŒ¢ï¼Œæ‰€ä»¥æ˜¯çµ•å°å€¼
                const debtAmount = Math.abs(debtor.amount);
                const payment = Math.min(lender.amount, debtAmount);

                settlements.push({
                    from: debtor.name, // æ¬ æ¬¾äººä»˜éŒ¢
                    to: lender.name,   // å‚µæ¬Šäººæ”¶éŒ¢
                    amount: payment
                });

                // æ›´æ–°é¤˜é¡
                lender.amount -= payment;
                debtor.amount += payment; // è² å€¼å¢åŠ  payment (æœ 0 ç§»å‹•)

                // ç§»å‹•æŒ‡é‡
                if (lender.amount < 0.01) {
                    i++; // å‚µæ¬Šäººå·²æ”¶æ¸…
                }
                if (debtor.amount > -0.01) {
                    j++; // æ¬ æ¬¾äººå·²é‚„æ¸…
                }
            }

            // 3. æ›´æ–°æ•¸æ“šæ¨¡å‹ä¸¦å„²å­˜
            itineraryData.cost.summary = settlements;
            if (shouldSave) {
                saveItinerary();
            } else {
                // å¦‚æœæ˜¯å…§éƒ¨èª¿ç”¨ (å¦‚åˆªé™¤äº¤æ˜“)ï¼Œå‰‡åªé‡æ–°æ¸²æŸ“ï¼Œä¸å¼·åˆ¶å„²å­˜
                renderCost(); 
            }
        }
        
        // ä¸» Tab åˆ‡æ› (ç¸½è¦½/æ¯æ—¥/ç¥¨åˆ¸/æˆæœ¬)
        function switchContent(tabId) {
            const tabs = ['overview', 'daily', 'booking', 'cost'];
            
            tabs.forEach(id => {
                document.getElementById(`content-${id}`).classList.add('hidden');
                document.getElementById(`tab-${id}`).classList.remove('border-blue-500', 'text-blue-700', 'font-bold');
                document.getElementById(`tab-${id}`).classList.add('text-gray-500', 'hover:text-gray-700', 'border-transparent', 'font-medium');
            });

            document.getElementById(`content-${tabId}`).classList.remove('hidden');
            document.getElementById(`tab-${tabId}`).classList.add('border-blue-500', 'text-blue-700', 'font-bold');
            document.getElementById(`tab-${tabId}`).classList.remove('text-gray-500', 'hover:text-gray-700', 'border-transparent', 'font-medium');

            // ç¢ºä¿åˆ‡æ›åˆ°ç¸½è¦½æ™‚ï¼Œå€’æ•¸è¨ˆæ™‚å™¨æ­£åœ¨æ›´æ–°
            if (tabId === 'overview' && !countdownInterval) {
                countdownInterval = setInterval(updateCountdown, 1000);
            }
        }

        // æ¯æ—¥è¡Œç¨‹ Tab åˆ‡æ›
        function switchDay(dayNum) {
            currentDay = dayNum;
            renderDayDetail(dayNum);

            // æ›´æ–° Day Tab æ¨£å¼
            document.querySelectorAll('.day-tab-button').forEach(btn => {
                btn.classList.remove('bg-blue-500', 'text-white', 'shadow-xl');
                btn.classList.add('bg-gray-200', 'text-gray-700', 'shadow-md');
            });
            const selectedButton = document.getElementById(`day-tab-${dayNum}`);
            if (selectedButton) {
                selectedButton.classList.add('bg-blue-500', 'text-white', 'shadow-xl');
                selectedButton.classList.remove('bg-gray-200', 'text-gray-700', 'shadow-md');
            }
        }
        
        // æ¸²æŸ“ç‰¹å®šä¸€å¤©çš„è©³ç´°è¡Œç¨‹ (Daily Itinerary Detail) - ä¿æŒä¸è®Š
        function renderDayDetail(dayNum) {
            const dayData = itineraryData.daily.find(d => d.dayNum === dayNum);
            if (!dayData) return;

            const detailContainer = document.getElementById('daily-itinerary-detail');
            const stopsHtml = dayData.stops.map(stop => `
                <div class="relative pl-8 pb-8 border-l-4 border-dashed border-blue-200">
                    <!-- æ™‚é–“è»¸åœ“é»ï¼ŒåŠ ä¸Šè„ˆè¡å‹•ç•« -->
                    <div class="timeline-dot absolute -left-5 top-0 w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white font-extrabold text-sm shadow-xl">
                        ${stop.time.split(':')[0]}
                    </div>
                    <div class="bg-white p-5 rounded-xl card-shadow border border-gray-100 transform hover:scale-[1.01] transition duration-300">
                        <h4 class="text-lg font-bold text-gray-800 mb-1">${stop.time} - ${stop.title}</h4>
                        <p class="text-sm text-gray-600">${stop.desc}</p>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-4 text-sm border-t pt-3">
                            <p class="text-gray-700"><strong class="text-red-600 font-semibold">è²»ç”¨ä¼°ç®—ï¼š</strong> ${stop.cost}</p>
                            <p class="text-gray-700"><strong class="text-green-600 font-semibold">æ³¨æ„äº‹é …ï¼š</strong> ${stop.notes}</p>
                        </div>
                        
                        ${stop.mapLink ? `
                        <a href="${stop.mapLink}" target="_blank" class="mt-4 inline-flex items-center text-blue-600 hover:text-blue-800 text-sm font-bold bg-blue-100 py-1 px-3 rounded-full transition duration-150">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.828 0l-4.243-4.243m10.606 0a8 8 0 10-10.606 0m10.606 0-4.243-4.243m0 0L6.343 16.657m4.243-4.243L12 11.243l1.414 1.414m-1.414 0l-1.414-1.414"></path></svg>
                            åœ°åœ–/è·¯ç·šè¦åŠƒ
                        </a>` : ''}
                    </div>
                </div>
            `).join('');

            detailContainer.innerHTML = `
                <h3 class="text-2xl font-bold text-gray-800 mb-5 bg-blue-50 border-l-4 border-blue-500 pl-3 p-3 rounded-lg shadow-md">
                    Day ${dayData.dayNum} (${dayData.date})ï¼š${dayData.theme}
                </h3>
                
                <div class="timeline mb-8 pl-4">
                    ${stopsHtml}
                </div>

                <div class="p-5 border-2 border-dashed border-purple-500 bg-purple-50 rounded-xl card-shadow">
                    <h4 class="font-bold text-lg text-purple-700 mb-1">â˜” å½ˆæ€§æ–¹æ¡ˆ (å‚™é¸/æ‡‰å°çªç™¼ç‹€æ³)</h4>
                    <p class="text-sm mt-1 text-gray-700">${dayData.flex}</p>
                    <p class="text-xs text-gray-500 mt-2">ï¼ˆè‹¥å¤©æ°£ä¸ä½³ã€é«”åŠ›ä¸æ¿Ÿæˆ–æ’éšŠäººæ½®éå¤šæ™‚ï¼Œå¯è€ƒæ…®æ­¤æ›¿ä»£æ–¹æ¡ˆã€‚ï¼‰</p>
                </div>
            `;
        }


        // === 5. åˆå§‹åŒ–æµç¨‹ (èªè­‰èˆ‡è¼‰å…¥è³‡æ–™) ===
        
        async function handleSignIn() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("ç™»å…¥éŒ¯èª¤:", error);
            }
        }
        
        function initFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase é…ç½®éºå¤±ã€‚æ‡‰ç”¨ç¨‹å¼ç„¡æ³•å•Ÿå‹•ã€‚");
                const statusElement = document.getElementById('save-status');
                if (statusElement) {
                     statusElement.textContent = 'âŒ Firebase åˆå§‹åŒ–å¤±æ•—ï¼Œç„¡æ³•ä½¿ç”¨å„²å­˜åŠŸèƒ½ã€‚';
                }
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
            } catch (e) {
                console.error("Firebase åˆå§‹åŒ–éŒ¯èª¤:", e);
                return;
            }

            // è¨­ç½®é©—è­‰ç‹€æ…‹ç›£è½å™¨
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    console.log(`User authenticated: ${userId}`);

                    // è¼‰å…¥è³‡æ–™ (ç¾åœ¨æœƒè¼‰å…¥å…±ç”¨è³‡æ–™)
                    loadItinerary(); 

                } else {
                    // å¦‚æœæ²’æœ‰ä½¿ç”¨è€…ï¼Œå‰‡å˜—è©¦ç™»å…¥
                    await handleSignIn();
                }

                // å•Ÿå‹•å€’æ•¸è¨ˆæ™‚å™¨
                if (!countdownInterval) {
                    countdownInterval = setInterval(updateCountdown, 1000);
                }
            });
            
            // ç”±æ–¼ loadItinerary() æœƒåœ¨ onAuthStateChanged å…§è§¸ç™¼ï¼Œ
            // é€™è£¡å…ˆå‘¼å«ä¸€æ¬¡ renderAllContent ä¾†ç¢ºä¿åˆå§‹ç•«é¢éª¨æ¶å­˜åœ¨ã€‚
            renderAllContent();
        }

        // ç¢ºä¿å‡½æ•¸å¯ä»¥åœ¨ HTML ä¸­è¢«èª¿ç”¨
        window.saveItinerary = saveItinerary;
        window.switchContent = switchContent;
        window.switchDay = switchDay;
        
        // ç¢ºä¿è²»ç”¨è¿½è¹¤å‡½æ•¸å¯ä»¥åœ¨ HTML ä¸­è¢«èª¿ç”¨
        window.addPerson = addPerson;
        window.removePerson = removePerson;
        window.addTransaction = addTransaction;
        window.removeTransaction = removeTransaction;
        window.calculateSettlement = calculateSettlement;
        window.formatAmount = formatAmount; // è®“å¤–éƒ¨å¯å‘¼å«
        window.setDisplayCurrency = setDisplayCurrency; // è²¨å¹£åˆ‡æ›

        initFirebase();

    </script>
</body>
</html>